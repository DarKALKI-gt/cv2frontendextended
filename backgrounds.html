<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futuristic Virtual Background App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111111; }
        .title-font { font-family: 'Orbitron', sans-serif; animation: subtle-glow 2.5s ease-in-out infinite alternate; }
        @keyframes subtle-glow {
            from { text-shadow: 0 0 4px #fff, 0 0 8px #0ea5e9, 0 0 12px #0ea5e9; }
            to { text-shadow: 0 0 8px #fff, 0 0 16px #0ea5e9, 0 0 24px #0ea5e9; }
        }
        .loader, .ai-loader { border: 5px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        .loader { border-top-color: #0ea5e9; }
        .ai-loader { width: 40px; height: 40px; border-top-color: #a855f7; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .glass-panel { background: rgba(23, 23, 23, 0.75); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border: 1px solid #404040; animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #rec-indicator { box-shadow: 0 0 5px #f43f5e, 0 0 10px #f43f5e; }
        .control-btn { background-color: #262626; border: 1px solid #525252; color: #d4d4d4; transition: all 0.2s ease-in-out; will-change: transform; padding: 0.5rem 1rem; white-space: nowrap; }
        .control-btn:hover { transform: translateY(-2px); border-color: #0ea5e9; background-color: rgba(14, 165, 233, 0.1); box-shadow: 0 0 12px rgba(14, 165, 233, 0.3); color: #fff; }
        #btn-analyze, #btn-invis-custom { border-color: #8b5cf6; color: #c4b5fd; }
        #btn-analyze:hover, #btn-invis-custom:hover { border-color: #a78bfa; box-shadow: 0 0 12px rgba(167, 139, 250, 0.4); }
        #btn-analyze-outfit, #btn-suggest-bg { border-color: #0d9488; color: #5eead4; }
        #btn-analyze-outfit:hover, #btn-suggest-bg:hover { border-color: #2dd4bf; box-shadow: 0 0 12px rgba(45, 212, 191, 0.4); }
        /* REMOVED: Styles for clone trail button */
        #btn-comic-book { border-color: #d97706; color: #fdba74; }
        #btn-comic-book:hover { border-color: #f59e0b; box-shadow: 0 0 12px rgba(245, 158, 11, 0.4); }
        #btn-rec { border-color: #be123c; color: #fda4af; }
        #btn-rec:hover { border-color: #f43f5e; background-color: rgba(244, 63, 94, 0.1); box-shadow: 0 0 12px rgba(244, 63, 94, 0.4); }
        .recording-active { background-color: #f43f5e !important; border-color: #fca5a5 !important; color: #fff !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 0 10px #f43f5e; animation: pulse-rec 1.5s infinite; }
        @keyframes pulse-rec { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        #analysis-modal { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-gray-200 flex flex-col items-center justify-center min-h-screen p-4 overflow-x-hidden">

    <div class="w-full h-full flex flex-col items-center justify-center gap-6 p-4">
        <div class="w-full flex flex-col items-center justify-center">
            <h1 class="title-font text-3xl md:text-4xl font-bold text-center mb-4 text-white">VIRTUAL BACKGROUND</h1>
            <div class="relative w-full max-w-4xl aspect-video bg-black/50 rounded-2xl shadow-2xl shadow-black/50 overflow-hidden border border-neutral-800">
                <canvas id="output_canvas" class="w-full h-full"></canvas>
                <video id="input_video" class="hidden" playsinline></video>
                <video id="bg_video" class="hidden" loop playsinline></video>
                <div id="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-black/90 rounded-2xl z-20">
                    <div class="loader"></div>
                    <p class="text-white mt-4 font-semibold text-lg">Initializing Camera...</p>
                </div>
                <div id="ai-loading" class="absolute inset-0 flex-col items-center justify-center bg-black/80 rounded-2xl z-20 hidden">
                    <div class="ai-loader"></div>
                    <p class="text-white mt-4 font-semibold text-lg">AI is thinking...</p>
                </div>
                <div id="rec-indicator" class="absolute top-4 left-4 flex items-center bg-rose-600 text-white px-4 py-2 rounded-full text-sm font-bold hidden z-10">
                    <div class="w-3 h-3 bg-white rounded-full mr-2 animate-pulse"></div>
                    REC
                </div>
            </div>
        </div>
        <div class="w-full max-w-5xl glass-panel p-4 rounded-2xl">
             <div class="flex flex-wrap justify-center gap-3">
                 <button id="btn-none" class="control-btn font-semibold rounded-lg">None</button>
                 <button id="btn-img1" class="control-btn font-semibold rounded-lg">Scenery</button>
                 <button id="btn-img2" class="control-btn font-semibold rounded-lg">Black</button>
                 <button id="btn-green" class="control-btn font-semibold rounded-lg">Green Screen</button>
                 <button id="btn-video" class="control-btn font-semibold rounded-lg">Rollercoaster</button>
                 <button id="btn-blur" class="control-btn font-semibold rounded-lg">Blur</button>
                 <button id="btn-invis" class="control-btn font-semibold rounded-lg">Invisibility</button>
                 <button id="btn-invis-custom" class="control-btn font-semibold rounded-lg">Custom Cloak</button>
                 <button id="btn-analyze" class="control-btn font-semibold rounded-lg">Analyze Scene</button>
                 <button id="btn-open" class="control-btn font-semibold rounded-lg">Open Image</button>
                 <button id="btn-rec" class="control-btn font-semibold rounded-lg">Record</button>
                 <button id="btn-analyze-outfit" class="control-btn font-semibold rounded-lg">Analyze Outfit</button>
                 <button id="btn-suggest-bg" class="control-btn font-semibold rounded-lg">Suggest BG</button>
                 <!-- REMOVED: Clone Trail button -->
                 <button id="btn-comic-book" class="control-btn font-semibold rounded-lg">Comic Book</button>
             </div>
             <input type="file" id="file-input" class="hidden" accept="image/*">
        </div>
    </div>
    
    <div id="analysis-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
        <div class="max-w-md w-full glass-panel rounded-2xl p-6 relative">
             <h3 id="analysis-title" class="text-xl font-bold text-violet-300 mb-4 title-font">Scene Analysis</h3>
             <p id="analysis-result" class="text-gray-300 whitespace-pre-wrap"></p>
             <button id="close-modal-btn" class="absolute top-4 right-4 text-2xl leading-none font-bold text-gray-400 hover:text-white transition">&times;</button>
        </div>
    </div>

    <script type="module">
        // --- DOM ELEMENT REFERENCES ---
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingIndicator = document.getElementById('loading');
        const aiLoadingIndicator = document.getElementById('ai-loading');
        const recIndicator = document.getElementById('rec-indicator');
        const fileInput = document.getElementById('file-input');
        const bgVideoElement = document.getElementById('bg_video');
        const analysisModal = document.getElementById('analysis-modal');
        const analysisTitleEl = document.getElementById('analysis-title'); 
        const analysisResultEl = document.getElementById('analysis-result');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // --- STATE MANAGEMENT ---
        const GEMINI_API_KEY = "AIzaSyDQ3ZLOpe2vBRiaPEd5jBZF-6oTm_fg-vc"; 
        let currentMode = 'none';
        let currentBg;
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let audioStream = null;
        let invisBg = null; 
        let fileInputPurpose = 'image';

        // --- SETUP ---
        videoElement.onloadedmetadata = () => {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
        };
        
        // --- BACKGROUND ASSETS ---
        const backgrounds = {};
        const bgImage1 = new Image();
        bgImage1.src = 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1280&auto=format&fit=crop';
        bgImage1.crossOrigin = "anonymous";
        bgImage1.onload = () => { 
            backgrounds['img1'] = bgImage1;
            if (!invisBg) {
                invisBg = bgImage1;
            }
        };
        const bgImage2 = new Image();
        bgImage2.src = 'https://images.unsplash.com/photo-1531306728370-e2ebd9d7bb92?q=80&w=1280&auto=format&fit=crop';
        bgImage2.crossOrigin = "anonymous";
        bgImage2.onload = () => { backgrounds['img2'] = bgImage2; };
        bgVideoElement.src = 'rollercoaster.mp4';
        bgVideoElement.crossOrigin = "anonymous"; 
        bgVideoElement.load();
        
        // --- MEDIAPIPE SELFIE SEGMENTATION ---
        const selfieSegmentation = new SelfieSegmentation({ locateFile: (file) => 
            `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
        });
        selfieSegmentation.setOptions({ modelSelection: 0 });
        selfieSegmentation.onResults(onResults);

        // --- CAMERA SETUP ---
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await selfieSegmentation.send({ image: videoElement });
            },
            width: 1280,
            height: 720
        });
        camera.start();
        videoElement.addEventListener('playing', () => {
            loadingIndicator.style.display = 'none';
        });

        // --- CORE LOGIC (onResults) ---
        function onResults(results) {
            const w = canvasElement.width;
            const h = canvasElement.height;
            const segmentationMask = results.segmentationMask;

            canvasCtx.save();
            
            // REMOVED: Check for clone trail is no longer needed.
            canvasCtx.clearRect(0, 0, w, h);
            
            if (currentMode === 'none') {
                canvasCtx.drawImage(results.image, 0, 0, w, h);
            } else if (['image', 'video', 'green', 'blur'].includes(currentMode)) {
                canvasCtx.drawImage(results.image, 0, 0, w, h);
                canvasCtx.globalCompositeOperation = 'destination-in';
                canvasCtx.drawImage(segmentationMask, 0, 0, w, h);
                canvasCtx.globalCompositeOperation = 'destination-over';
                switch (currentMode) {
                    case 'image':
                        if (currentBg) canvasCtx.drawImage(currentBg, 0, 0, w, h);
                        else { canvasCtx.fillStyle = '#000000'; canvasCtx.fillRect(0, 0, w, h); }
                        break;
                    case 'video':
                        canvasCtx.drawImage(bgVideoElement, 0, 0, w, h);
                        break;
                    case 'blur':
                        canvasCtx.filter = 'blur(10px)';
                        canvasCtx.drawImage(results.image, 0, 0, w, h);
                        canvasCtx.filter = 'none';
                        break;
                    case 'green':
                        canvasCtx.fillStyle = '#00FF00';
                        canvasCtx.fillRect(0, 0, w, h);
                        break;
                }
            } else if (currentMode === 'invisible') {
                canvasCtx.drawImage(results.image, 0, 0, w, h);
                canvasCtx.globalCompositeOperation = 'destination-out';
                canvasCtx.drawImage(segmentationMask, 0, 0, w, h);
                canvasCtx.globalCompositeOperation = 'destination-over';
                if (invisBg) {
                    canvasCtx.drawImage(invisBg, 0, 0, w, h);
                } else { 
                   canvasCtx.fillStyle = '#111111';
                   canvasCtx.fillRect(0, 0, w, h);
                }
            // REMOVED: Clone Trail rendering logic.
            } else if (currentMode === 'comicBook') {
                if (backgrounds['img1']) canvasCtx.drawImage(backgrounds['img1'], 0, 0, w, h);
                canvasCtx.globalCompositeOperation = 'source-over';
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = w; tempCanvas.height = h;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(results.image, 0, 0, w, h);
                tempCtx.globalCompositeOperation = 'destination-in';
                tempCtx.drawImage(segmentationMask, 0, 0, w, h);
                canvasCtx.filter = `saturate(180%) contrast(150%) drop-shadow(3px 3px 0 #000) drop-shadow(-3px -3px 0 #000) drop-shadow(3px -3px 0 #000) drop-shadow(-3px 3px 0 #000)`;
                canvasCtx.drawImage(tempCanvas, 0, 0, w, h);
            } else {
               canvasCtx.drawImage(results.image, 0, 0, w, h);
            }
            canvasCtx.restore();
        }

        // --- UI EVENT LISTENERS ---
        document.getElementById('btn-none').onclick = () => { currentMode = 'none'; bgVideoElement.pause(); };
        document.getElementById('btn-img1').onclick = () => { currentMode = 'image'; currentBg = backgrounds['img1']; bgVideoElement.pause(); };
        document.getElementById('btn-img2').onclick = () => { currentMode = 'image'; currentBg = backgrounds['img2']; bgVideoElement.pause(); };
        document.getElementById('btn-green').onclick = () => { currentMode = 'green'; bgVideoElement.pause(); };
        document.getElementById('btn-blur').onclick = () => { currentMode = 'blur'; bgVideoElement.pause(); };
        document.getElementById('btn-invis').onclick = () => { 
            invisBg = backgrounds['img1'];
            currentMode = 'invisible'; 
            bgVideoElement.pause(); 
        };
        document.getElementById('btn-video').onclick = () => { 
            currentMode = 'video'; 
            bgVideoElement.play();
        };
        document.getElementById('btn-open').onclick = () => {
            fileInputPurpose = 'image';
            fileInput.click();
        };
        document.getElementById('btn-invis-custom').onclick = () => {
            fileInputPurpose = 'invisibility';
            fileInput.click();
        };
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        if (fileInputPurpose === 'image') {
                            backgrounds['custom'] = img;
                            currentBg = backgrounds['custom'];
                            currentMode = 'image';
                            bgVideoElement.pause();
                        } else if (fileInputPurpose === 'invisibility') {
                            invisBg = img;
                            currentMode = 'invisible';
                            bgVideoElement.pause();
                        }
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        };
        document.getElementById('btn-analyze').onclick = analyzeScene;
        document.getElementById('btn-rec').onclick = () => {
            isRecording = !isRecording;
            if (isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        };
        closeModalBtn.onclick = () => {
            analysisModal.classList.add('hidden');
        };
        document.getElementById('btn-analyze-outfit').onclick = analyzeOutfit;
        document.getElementById('btn-suggest-bg').onclick = suggestBackgrounds;
        // REMOVED: Event listener for Clone Trail
        document.getElementById('btn-comic-book').onclick = () => { currentMode = 'comicBook'; bgVideoElement.pause(); };

        // --- GEMINI API FUNCTION ---
        async function analyzeScene() {
            analysisTitleEl.textContent = 'Scene Analysis'; 
            aiLoadingIndicator.style.display = 'flex';
            try {
                const imageDataUrl = canvasElement.toDataURL('image/jpeg');
                const base64ImageData = imageDataUrl.split(',')[1];
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
                const payload = { "contents": [{"parts": [ { "text": "Describe what you see in this image in a concise, friendly way." }, { "inline_data": { "mime_type": "image/jpeg", "data": base64ImageData } } ]}] };
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`API Error: ${error.error.message}`);
                }
                const result = await response.json();
                const description = result.candidates[0].content.parts[0].text;
                analysisResultEl.textContent = description;
                analysisModal.classList.remove('hidden');
            } catch (error) {
                console.error("Error analyzing scene:", error);
                analysisResultEl.textContent = `Error: Could not analyze the scene. ${error.message}`;
                analysisModal.classList.remove('hidden');
            } finally {
                aiLoadingIndicator.style.display = 'none';
            }
        }

        // --- RECORDING FUNCTIONS ---
        async function startRecording() {
             const recBtn = document.getElementById('btn-rec');
             try {
                 const videoStream = canvasElement.captureStream(30);
                 audioStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                 const combinedStream = new MediaStream([ ...videoStream.getVideoTracks(), ...audioStream.getAudioTracks() ]);
                 mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm; codecs=vp9,opus' });
                 mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) recordedChunks.push(event.data); };
                 mediaRecorder.onstop = () => {
                     const blob = new Blob(recordedChunks, { type: 'video/webm' });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = `recording-${new Date().toISOString()}.webm`;
                     document.body.appendChild(a);
                     a.click();
                     window.URL.revokeObjectURL(url);
                     recordedChunks = [];
                 };
                 mediaRecorder.start();
                 recIndicator.classList.remove('hidden');
                 recBtn.textContent = 'Stop';
                 recBtn.classList.add('recording-active');
             } catch (err) {
                 console.error("Error starting recording:", err);
                 analysisResultEl.textContent = `Could not start recording. Please grant microphone permission. Error: ${err.message}`;
                 analysisModal.classList.remove('hidden');
                 isRecording = false; 
             }
         }
        function stopRecording() {
             if (mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); }
             if (audioStream) { audioStream.getTracks().forEach(track => track.stop()); audioStream = null; }
             const recBtn = document.getElementById('btn-rec');
             recIndicator.classList.add('hidden');
             recBtn.textContent = 'Record';
             recBtn.classList.remove('recording-active');
         }

        // --- AI FEATURE FUNCTIONS ---
        async function analyzeOutfit() {
            analysisTitleEl.textContent = 'AI Outfit Analysis';
            aiLoadingIndicator.style.display = 'flex';
            try {
                const imageDataUrl = canvasElement.toDataURL('image/jpeg');
                const base64ImageData = imageDataUrl.split(',')[1];
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
                const payload = { "contents": [{"parts": [ { "text": "You are a friendly fashion assistant. Briefly describe the color and style of the clothing worn by the person in this image." }, { "inline_data": { "mime_type": "image/jpeg", "data": base64ImageData } } ]}] };
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`API Error: ${error.error.message}`);
                }
                const result = await response.json();
                const description = result.candidates[0].content.parts[0].text;
                analysisResultEl.textContent = description;
                analysisModal.classList.remove('hidden');
            } catch (error) {
                console.error("Error analyzing outfit:", error);
                analysisResultEl.textContent = `Error: Could not analyze outfit. ${error.message}`;
                analysisModal.classList.remove('hidden');
            } finally {
                aiLoadingIndicator.style.display = 'none';
            }
        }
        async function suggestBackgrounds() {
            analysisTitleEl.textContent = 'AI Background Suggestions';
            aiLoadingIndicator.style.display = 'flex';
            try {
                const imageDataUrl = canvasElement.toDataURL('image/jpeg');
                const base64ImageData = imageDataUrl.split(',')[1];
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
                const payload = { "contents": [{"parts": [ { "text": "You are a creative assistant. Based on the person in this image, suggest three creative virtual background ideas. For each suggestion, give it a bold title on a new line, and then a one-sentence description below it. Format your response clearly with line breaks between each suggestion." }, { "inline_data": { "mime_type": "image/jpeg", "data": base64ImageData } } ]}] };
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`API Error: ${error.error.message}`);
                }
                const result = await response.json();
                const description = result.candidates[0].content.parts[0].text;
                analysisResultEl.textContent = description;
                analysisModal.classList.remove('hidden');
            } catch (error) {
                console.error("Error suggesting backgrounds:", error);
                analysisResultEl.textContent = `Error: Could not suggest backgrounds. ${error.message}`;
                analysisModal.classList.remove('hidden');
            } finally {
                aiLoadingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>
